import { Subject } from 'rxjs'
import sourceCreator from '@rampant/source-creator'
import configureIntentStreamCreator from '@rampant/create-intent-stream'

export default ({ plugins }) => {
    const engine = new Subject()
    const createSource = sourceCreator({ plugins })
    const intentStreams = {}
    const intentSubscriptions = {}
    const createIntentStream = configureIntentStreamCreator({ plugins })

    const sourcePool = {}
    const addSource = async sourceSettings => {
        const { name = 'empty' } = sourceSettings
        if (name in sourcePool) return

        const source = await createSource(sourceSettings, sourcePool)
        sourcePool[name] = source
    }

    engine.addSource = addSource

    const fillIntent = raw => {
        const { name, sources = [] } = raw
        const filledSources =
            sources.length === 0 ? [{ name, intent: name }] : sources
        return { ...raw, sources: filledSources }
    }

    engine.addIntent = (id, rawIntent) => {
        const intent = fillIntent(rawIntent)

        return Promise.all(intent.sources.map(addSource)).then(() => {
            const intentStream = createIntentStream({ sourcePool, intent })
            const intentSubscription = intentStream.subscribe(engine)

            intentStreams[id] = intentStream
            intentSubscriptions[id] = intentSubscription
        })
    }

    engine.removeIntent = id => {
        delete intentStreams[id]
        const intentSubscription = intentSubscriptions[id]
        intentSubscription.unsubscribe()
        delete intentSubscriptions[id]
    }

    return engine
}

import find from 'lodash.find'
import { prettify } from '@rampant/logger'
import sort from '@rampant/topological-sort'
import serialPromise from '@rampant/serial-promise'

export default ({ logger, intentEngine }) => ({ sources = [] }) => {
    logger.platform('Creating Project Sources...')
    const dependencyList = sources.reduce(
        (list, { name, dependencies = [] }) => ({
            ...list,
            [name]: dependencies,
        }),
        {}
    )

    const sortedDependencyCreators = sort(dependencyList)
        .map(sourceName => find(sources, { name: sourceName }))
        .map(source => () =>
            intentEngine.addSource(source).then(_ => {
                const { name } = source
                const deps = dependencyList[name]
                logger.detail(
                    `Project source [${name}] was added${
                        deps.length > 0 ? ` (Depended on: [${deps}])` : ''
                    }`
                )
                logger.debug(prettify(source))
                return _
            })
        )

    return serialPromise(sortedDependencyCreators).then(_ => {
        logger.platform('Project Sources Created')
        return _
    })
}
